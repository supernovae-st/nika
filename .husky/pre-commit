#!/usr/bin/env sh

# Pre-commit validation for Nika
# - Rust formatting (cargo fmt)
# - Clippy lints
# - Workflow file validation (.nika.yaml)

set -e

NIKA_DIR="tools/nika"

# =============================================================================
# Rust Formatting Check
# =============================================================================

if git diff --cached --name-only | grep -q "\.rs$"; then
  echo "ğŸ¦€ Rust files changed - checking formatting..."

  cd "$NIKA_DIR"
  if ! cargo fmt --check 2>/dev/null; then
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âŒ Rust formatting check failed!"
    echo ""
    echo "To fix, run:"
    echo "  cd $NIKA_DIR && cargo fmt"
    echo ""
    echo "Then stage the formatted files:"
    echo "  git add <files>"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 1
  fi
  cd - > /dev/null

  echo "âœ… Rust formatting validated"
fi

# =============================================================================
# Clippy Lints
# =============================================================================

if git diff --cached --name-only | grep -q "\.rs$"; then
  echo "ğŸ“ Running clippy..."

  cd "$NIKA_DIR"
  if ! cargo clippy --all-targets --all-features -- -D warnings 2>/dev/null; then
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âŒ Clippy found issues!"
    echo ""
    echo "To see details, run:"
    echo "  cd $NIKA_DIR && cargo clippy --all-targets --all-features"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 1
  fi
  cd - > /dev/null

  echo "âœ… Clippy passed"
fi

# =============================================================================
# Nika Workflow File Validation (.nika.yaml)
# =============================================================================

if git diff --cached --name-only | grep -q "\.nika\.yaml$"; then
  echo "ğŸ“‹ Nika workflow files changed - validating..."

  cd "$NIKA_DIR"

  # Get list of changed .nika.yaml files
  CHANGED_WORKFLOWS=$(git diff --cached --name-only | grep "\.nika\.yaml$" || true)

  for workflow in $CHANGED_WORKFLOWS; do
    if [ -f "../../$workflow" ]; then
      echo "  Validating $workflow..."
      if ! cargo run --quiet -- validate "../../$workflow" 2>/dev/null; then
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "âŒ Workflow validation failed: $workflow"
        echo ""
        echo "To see details, run:"
        echo "  cd $NIKA_DIR && cargo run -- validate ../../$workflow"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        exit 1
      fi
    fi
  done
  cd - > /dev/null

  echo "âœ… Workflow files validated"
fi

echo "ğŸ‰ Pre-commit checks passed!"
