# Implementation Roadmap v0.5.3 → v0.7

**Date:** 2026-02-21
**Author:** Claude Opus 4.5
**Status:** In Progress

---

## Overview

This document details the implementation plan for Nika v0.5.3 through v0.7, addressing gaps identified in the 10-agent audit.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ROADMAP OVERVIEW                                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  v0.5.3 (Stability)     ████████████████████████  CRITICAL                 │
│  ├── MCP timeout enforcement                                               │
│  ├── MCP error code preservation                                           │
│  └── Cache token reporting                                                  │
│                                                                             │
│  v0.6 (Features)        ████████████░░░░░░░░░░░░  HIGH                      │
│  ├── rig-core chat history                                                  │
│  ├── Additional providers (Mistral/Ollama)                                  │
│  └── tiktoken-rs token counting                                             │
│                                                                             │
│  v0.7 (Advanced)        ████░░░░░░░░░░░░░░░░░░░░  MEDIUM                    │
│  ├── MCP list_resources                                                     │
│  ├── MCP prompts API                                                        │
│  └── Vision/multimodal (future)                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Phase 1: v0.5.3 — Stability (CRITICAL)

### 1.1 MCP Timeout Enforcement

**File:** `src/mcp/rmcp_adapter.rs`
**Lines:** 223-261 (call_tool method)

**Problem:** `service.call_tool()` can hang indefinitely if MCP server is unresponsive.

**Solution:** Wrap all MCP calls with `tokio::time::timeout()`.

```rust
// Before (current)
let result = service
    .call_tool(request)
    .await
    .map_err(|e| NikaError::McpToolError { ... })?;

// After (with timeout)
use tokio::time::{timeout, Duration};

const MCP_CALL_TIMEOUT: Duration = Duration::from_secs(30);

let result = timeout(MCP_CALL_TIMEOUT, service.call_tool(request))
    .await
    .map_err(|_| NikaError::Timeout {
        operation: format!("MCP tool: {}", name),
        duration_ms: MCP_CALL_TIMEOUT.as_millis() as u64,
    })?
    .map_err(|e| NikaError::McpToolError { ... })?;
```

**Changes:**
1. Add `const MCP_CALL_TIMEOUT: Duration = Duration::from_secs(30);` at module level
2. Wrap `call_tool()` with timeout
3. Wrap `read_resource()` with timeout
4. Wrap `list_tools()` with timeout
5. Add tests for timeout behavior

**Tests:**
- `test_call_tool_timeout_returns_error`
- `test_read_resource_timeout_returns_error`
- `test_list_tools_timeout_returns_error`

---

### 1.2 MCP Error Code Preservation

**File:** `src/mcp/rmcp_adapter.rs`
**Problem:** `e.to_string()` loses JSON-RPC error codes (-32600, -32602, etc.)

**Solution:** Create `McpErrorCode` enum and extract from rmcp errors.

```rust
/// MCP JSON-RPC error codes (per MCP spec)
#[derive(Debug, Clone, Copy, PartialEq)]
pub enum McpErrorCode {
    InvalidRequest,    // -32600
    MethodNotFound,    // -32601
    InvalidParams,     // -32602
    InternalError,     // -32603
    ParseError,        // -32700
    ServerError(i32),  // -32000 to -32099
    Unknown(i32),
}

impl McpErrorCode {
    pub fn from_code(code: i32) -> Self {
        match code {
            -32600 => Self::InvalidRequest,
            -32601 => Self::MethodNotFound,
            -32602 => Self::InvalidParams,
            -32603 => Self::InternalError,
            -32700 => Self::ParseError,
            c if (-32099..=-32000).contains(&c) => Self::ServerError(c),
            c => Self::Unknown(c),
        }
    }
}
```

**Changes:**
1. Add `McpErrorCode` enum to `src/mcp/types.rs`
2. Update `NikaError::McpToolError` to include optional error code
3. Extract error code from rmcp error in `call_tool()`

---

### 1.3 Cache Token Reporting

**File:** `src/event/log.rs`
**Status:** Already implemented! `cache_read_tokens` exists in `ProviderResponded` and `AgentTurnMetadata`.

**Verification needed:** Ensure `cache_read_tokens` is populated in:
- `src/provider/rig.rs` - `infer_stream()` ✅ (uses `cached_input_tokens`)
- `src/runtime/rig_agent_loop.rs` - agent turns

---

## Phase 2: v0.6 — Features (HIGH)

### 2.1 rig-core Chat History

**File:** `src/runtime/rig_agent_loop.rs`
**Current:** Uses `agent.prompt()` (stateless single-turn)
**Available:** `agent.chat()` (maintains conversation history)

**Implementation:**

```rust
use rig::agent::Chat;

// In RigAgentLoop
struct RigAgentLoop {
    // ... existing fields
    chat_history: Option<Vec<rig::message::Message>>,
}

impl RigAgentLoop {
    /// Run agent with chat history preservation
    pub async fn run_with_history(&mut self) -> Result<String> {
        let agent = self.build_agent()?;
        let mut chat = agent.chat();

        // Add system prompt
        chat = chat.system(&self.params.prompt);

        // Run conversation loop
        for turn in 0..self.params.max_turns.unwrap_or(10) {
            let response = chat.prompt(&self.current_prompt).await?;
            // ... handle tool calls, emit events
        }

        Ok(response)
    }
}
```

**Benefits:**
- Context retention across turns
- Better multi-turn agent performance
- Reduced token usage (no context rebuilding)

---

### 2.2 Additional Providers (Mistral/Ollama)

**File:** `src/provider/rig.rs`

**Add to RigProvider enum:**

```rust
pub enum RigProvider {
    Claude(anthropic::Client),
    OpenAI(openai::Client),
    Mistral(mistral::Client),    // NEW
    Ollama(ollama::Client),      // NEW - local LLM
}

impl RigProvider {
    pub fn mistral() -> Self {
        let client = mistral::Client::from_env();
        RigProvider::Mistral(client)
    }

    pub fn ollama(base_url: Option<&str>) -> Self {
        let client = ollama::Client::new(
            base_url.unwrap_or("http://localhost:11434")
        );
        RigProvider::Ollama(client)
    }
}
```

**Cargo.toml additions:**
```toml
[dependencies]
rig-core = { version = "0.31", features = ["rmcp", "mistral", "ollama"] }
```

---

### 2.3 tiktoken-rs Token Counting

**New file:** `src/provider/tokenizer.rs`

**Purpose:** Pre-API token estimation to prevent budget overrun.

```rust
use tiktoken_rs::{cl100k_base, CoreBPE};

pub struct TokenCounter {
    encoder: CoreBPE,
}

impl TokenCounter {
    pub fn new() -> Self {
        Self {
            encoder: cl100k_base().unwrap(),
        }
    }

    /// Count tokens in text (cl100k for Claude/GPT-4)
    pub fn count(&self, text: &str) -> usize {
        self.encoder.encode_ordinary(text).len()
    }

    /// Estimate if prompt fits within budget
    pub fn fits_budget(&self, text: &str, budget: usize) -> bool {
        self.count(text) <= budget
    }
}
```

**Cargo.toml:**
```toml
tiktoken-rs = "0.6"
```

---

## Phase 3: v0.7 — Advanced (MEDIUM)

### 3.1 MCP list_resources

**File:** `src/mcp/rmcp_adapter.rs`

**Add method:**

```rust
/// List all available resources from the MCP server.
pub async fn list_resources(&self) -> Result<Vec<ResourceDefinition>> {
    let guard = self.service.lock().await;
    let service = guard.as_ref().ok_or_else(|| NikaError::McpNotConnected {
        name: self.name.clone(),
    })?;

    let result = timeout(
        MCP_CALL_TIMEOUT,
        service.list_resources(Default::default())
    )
    .await
    .map_err(|_| NikaError::Timeout { ... })??;

    // Convert rmcp resources to Nika's ResourceDefinition
    Ok(result.resources.into_iter().map(|r| {
        ResourceDefinition {
            uri: r.uri.to_string(),
            name: r.name.map(|n| n.to_string()),
            description: r.description.map(|d| d.to_string()),
            mime_type: r.mime_type.map(|m| m.to_string()),
        }
    }).collect())
}
```

---

### 3.2 MCP Prompts API

**File:** `src/mcp/rmcp_adapter.rs`

**Add methods:**

```rust
/// List available prompts from MCP server
pub async fn list_prompts(&self) -> Result<Vec<PromptDefinition>> {
    // Similar to list_tools()
}

/// Get a specific prompt by name
pub async fn get_prompt(&self, name: &str, args: Value) -> Result<PromptContent> {
    // Call prompts/get
}
```

**New types in `src/mcp/types.rs`:**

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct PromptDefinition {
    pub name: String,
    pub description: Option<String>,
    pub arguments: Option<Vec<PromptArgument>>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct PromptContent {
    pub description: Option<String>,
    pub messages: Vec<PromptMessage>,
}
```

---

## Implementation Order

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  EXECUTION ORDER                                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. [CRITICAL] MCP timeout     ─────────────────────────────►  30 min      │
│  2. [HIGH]     MCP error codes ─────────────────────────────►  1 hour      │
│  3. [HIGH]     Verify cache tokens ─────────────────────────►  30 min      │
│  4. [HIGH]     Chat history    ─────────────────────────────►  2 hours     │
│  5. [MEDIUM]   Providers       ─────────────────────────────►  4 hours     │
│  6. [MEDIUM]   tiktoken-rs     ─────────────────────────────►  2 hours     │
│  7. [MEDIUM]   list_resources  ─────────────────────────────►  2 hours     │
│  8. [LOW]      prompts API     ─────────────────────────────►  3 hours     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Test Strategy

### v0.5.3 Tests
```rust
// In rmcp_adapter.rs
#[tokio::test]
async fn test_call_tool_timeout_returns_nika_timeout_error()
#[tokio::test]
async fn test_read_resource_timeout_returns_nika_timeout_error()
#[tokio::test]
async fn test_mcp_error_preserves_json_rpc_code()
```

### v0.6 Tests
```rust
// In rig_agent_loop.rs
#[tokio::test]
async fn test_chat_history_preserved_across_turns()
#[tokio::test]
async fn test_mistral_provider_infer()
#[tokio::test]
async fn test_ollama_provider_local()

// In tokenizer.rs
#[test]
fn test_token_count_matches_api()
#[test]
fn test_budget_check_accurate()
```

---

## Version Bumps

After each phase:

1. Update `Cargo.toml` version
2. Update `CLAUDE.md` version reference
3. Add `CHANGELOG.md` entry
4. Run full test suite
5. Commit with conventional message

```bash
# v0.5.3
git commit -m "fix(mcp): add timeout enforcement and error code preservation"

# v0.6
git commit -m "feat(provider): add chat history, Mistral/Ollama, tiktoken"

# v0.7
git commit -m "feat(mcp): add list_resources and prompts API"
```
