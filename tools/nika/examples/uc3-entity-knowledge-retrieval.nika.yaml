# UC3: Entity Knowledge Retrieval
# Retrieves full semantic neighborhood of an entity
#
# DAG: entity → [describe, requires, enables, similar, industries] → knowledge_map
#
schema: "nika/workflow@0.2"
provider: claude

mcp:
  novanet:
    # Use cargo to run MCP server from source (development mode)
    # Run from nika-dev/tools/nika/ directory
    command: cargo
    args:
      - run
      - --manifest-path
      - ../../../novanet-dev/tools/novanet-mcp/Cargo.toml
    env:
      NOVANET_MCP_NEO4J_URI: bolt://localhost:7687
      NOVANET_MCP_NEO4J_USER: neo4j
      NOVANET_MCP_NEO4J_PASSWORD: novanetpassword
      RUST_LOG: info

tasks:
  # ─────────────────────────────────────────────────────────────────
  # Input - static entity key (env: block doesn't work for exec commands)
  # ─────────────────────────────────────────────────────────────────

  - id: entity_key
    exec:
      command: "echo dynamic-qr-code"

  # ─────────────────────────────────────────────────────────────────
  # Parallel graph traversals (fan-out)
  # ─────────────────────────────────────────────────────────────────

  - id: describe
    use:
      key: entity_key
    invoke:
      mcp: novanet
      tool: novanet_describe
      params:
        describe: "entity"
        entity_key: "{{use.key}}"
    output:
      format: json

  - id: requires
    use:
      key: entity_key
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "{{use.key}}"
        arc_kinds: ["REQUIRES"]
        direction: "outgoing"
        max_depth: 2
        limit: 50
        include_properties: true
    output:
      format: json

  - id: enables
    use:
      key: entity_key
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "{{use.key}}"
        arc_kinds: ["ENABLES"]
        direction: "outgoing"
        max_depth: 1
        limit: 50
        include_properties: true
    output:
      format: json

  - id: similar_to
    use:
      key: entity_key
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "{{use.key}}"
        arc_kinds: ["SIMILAR_TO"]
        direction: "outgoing"
        max_depth: 1
        limit: 50
        include_properties: true
    output:
      format: json

  - id: industries
    use:
      key: entity_key
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "{{use.key}}"
        arc_kinds: ["APPLIES_TO"]
        direction: "outgoing"
        max_depth: 1
        limit: 50
        include_properties: true
    output:
      format: json

  # ─────────────────────────────────────────────────────────────────
  # Knowledge map synthesis (fan-in)
  # ─────────────────────────────────────────────────────────────────

  - id: knowledge_map
    use:
      desc: describe
      deps: requires
      unlocks: enables
      alts: similar_to
      sectors: industries
    infer:
      prompt: |
        Build a product knowledge map for entity.

        DESCRIPTION:
        {{use.desc}}

        REQUIRES (dependencies):
        {{use.deps}}

        ENABLES (what it unlocks):
        {{use.unlocks}}

        ALTERNATIVES:
        {{use.alts}}

        APPLICABLE INDUSTRIES:
        {{use.sectors}}

        Produce:
        1. One-line definition
        2. Dependency chain
        3. Feature matrix
        4. Competitive positioning
        5. Top 3 target industries

        Format: clean markdown.

flows:
  - source: entity_key
    target: [describe, requires, enables, similar_to, industries]
  - source: [describe, requires, enables, similar_to, industries]
    target: knowledge_map
