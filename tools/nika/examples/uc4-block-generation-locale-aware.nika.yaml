# UC4: Block Generation with Locale Context
# Generates a hero block with authentic locale knowledge atoms
#
# DAG: [entity, locale] → [ctx, voice, expressions, taboos] → generate → validate
#
schema: "nika/workflow@0.2"
provider: claude

mcp:
  novanet:
    # Use cargo to run MCP server from source (development mode)
    # Run from nika-dev/tools/nika/ directory
    command: cargo
    args:
      - run
      - --manifest-path
      - ../../../novanet-dev/tools/novanet-mcp/Cargo.toml
    env:
      NOVANET_MCP_NEO4J_URI: bolt://localhost:7687
      NOVANET_MCP_NEO4J_USER: neo4j
      NOVANET_MCP_NEO4J_PASSWORD: novanetpassword
      RUST_LOG: info

tasks:
  # ─────────────────────────────────────────────────────────────────
  # Inputs
  # ─────────────────────────────────────────────────────────────────

  - id: entity_key
    exec:
      command: "echo qr-code-art"

  - id: locale_key
    exec:
      command: "echo fr-FR"

  # ─────────────────────────────────────────────────────────────────
  # Parallel context loading (fan-out)
  # ─────────────────────────────────────────────────────────────────

  - id: entity_context
    use:
      entity: entity_key
    invoke:
      mcp: novanet
      tool: novanet_describe
      params:
        describe: "entity"
        entity_key: "{{use.entity}}"
    output:
      format: json

  - id: locale_voice
    use:
      locale: locale_key
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "{{use.locale}}"
        arc_kinds: ["HAS_VOICE"]
        direction: "outgoing"
        max_depth: 1
        limit: 10
        include_properties: true
    output:
      format: json

  - id: locale_expressions
    use:
      locale: locale_key
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "{{use.locale}}"
        arc_kinds: ["HAS_EXPRESSIONS"]
        direction: "outgoing"
        max_depth: 2
        limit: 15
        include_properties: true
    output:
      format: json

  - id: locale_taboos
    use:
      locale: locale_key
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "{{use.locale}}"
        arc_kinds: ["HAS_TABOOS"]
        direction: "outgoing"
        max_depth: 2
        limit: 20
        include_properties: true
    output:
      format: json

  # ─────────────────────────────────────────────────────────────────
  # Hero block generation (fan-in)
  # ─────────────────────────────────────────────────────────────────

  - id: generate_hero
    use:
      locale: locale_key
      entity_ctx: entity_context
      voice: locale_voice
      expressions: locale_expressions
      taboos: locale_taboos
    infer:
      prompt: |
        Generate a HERO block for QR Code AI in native {{use.locale}}.

        ENTITY CONTEXT:
        {{use.entity_ctx}}

        LOCALE VOICE ({{use.locale}}):
        {{use.voice}}

        AUTHENTIC EXPRESSIONS TO USE:
        {{use.expressions}}

        TABOOS TO AVOID:
        {{use.taboos}}

        Generate:
        - title: compelling, native {{use.locale}}
        - subtitle: 1-2 sentences product value
        - cta_primary: action-oriented, 2-4 words
        - cta_secondary: softer alternative

        RULES:
        - Generate natively, NOT translated
        - Brand "QR Code AI" is [FIXED]
        - Zero taboos

        Output as JSON: {title, subtitle, cta_primary, cta_secondary}
      model: claude-opus-4-5-20251101
    output:
      format: json

  # ─────────────────────────────────────────────────────────────────
  # Quality validation
  # ─────────────────────────────────────────────────────────────────

  - id: validate_block
    use:
      locale: locale_key
      hero_block: generate_hero
      voice: locale_voice
      taboos: locale_taboos
    infer:
      prompt: |
        Quality check this {{use.locale}} hero block:

        GENERATED CONTENT:
        {{use.hero_block}}

        VOICE REQUIREMENTS:
        {{use.voice}}

        TABOOS:
        {{use.taboos}}

        Check:
        1. Is title compelling and native?
        2. Does it respect voice formality?
        3. Any taboos violated?
        4. Is "QR Code AI" preserved?
        5. CTA length 2-4 words?

        Output JSON: {passed: bool, score: 0-10, issues: [], approved_content: {...}}
    output:
      format: json

flows:
  - source: [entity_key, locale_key]
    target: entity_context
  - source: locale_key
    target: [locale_voice, locale_expressions, locale_taboos]
  - source: [entity_context, locale_voice, locale_expressions, locale_taboos]
    target: generate_hero
  - source: generate_hero
    target: validate_block
