# UC5: Semantic Content Planning
# Discovers coverage gaps across entity x locale matrix
#
# DAG: pillars → [coverage_*] → gap_analysis → sprint_plan
#
schema: "nika/workflow@0.2"
provider: claude

mcp:
  novanet:
    # Use cargo to run MCP server from source (development mode)
    # Run from nika-dev/tools/nika/ directory
    command: cargo
    args:
      - run
      - --manifest-path
      - ../../../novanet-dev/tools/novanet-mcp/Cargo.toml
    env:
      NOVANET_MCP_NEO4J_URI: bolt://localhost:7687
      NOVANET_MCP_NEO4J_USER: neo4j
      NOVANET_MCP_NEO4J_PASSWORD: novanetpassword
      RUST_LOG: info

tasks:
  # ─────────────────────────────────────────────────────────────────
  # PHASE 1: Discovery
  # ─────────────────────────────────────────────────────────────────

  - id: discover_pillars
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "qrcode-ai"
        arc_kinds: ["HAS_ENTITY"]
        direction: "outgoing"
        max_depth: 1
        limit: 50
        include_properties: true
    output:
      format: json

  # Check coverage for each priority locale (parallel fan-out)

  - id: coverage_fr
    use:
      pillars: discover_pillars
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "fr-FR"
        arc_kinds: ["FOR_LOCALE"]
        direction: "incoming"
        target_kinds: ["PageNative"]
        max_depth: 1
        limit: 100
        include_properties: true
    output:
      format: json

  - id: coverage_en
    use:
      pillars: discover_pillars
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "en-US"
        arc_kinds: ["FOR_LOCALE"]
        direction: "incoming"
        target_kinds: ["PageNative"]
        max_depth: 1
        limit: 100
        include_properties: true
    output:
      format: json

  - id: coverage_es
    use:
      pillars: discover_pillars
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "es-ES"
        arc_kinds: ["FOR_LOCALE"]
        direction: "incoming"
        target_kinds: ["PageNative"]
        max_depth: 1
        limit: 100
        include_properties: true
    output:
      format: json

  - id: coverage_de
    use:
      pillars: discover_pillars
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "de-DE"
        arc_kinds: ["FOR_LOCALE"]
        direction: "incoming"
        target_kinds: ["PageNative"]
        max_depth: 1
        limit: 100
        include_properties: true
    output:
      format: json

  - id: coverage_pt
    use:
      pillars: discover_pillars
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "pt-BR"
        arc_kinds: ["FOR_LOCALE"]
        direction: "incoming"
        target_kinds: ["PageNative"]
        max_depth: 1
        limit: 100
        include_properties: true
    output:
      format: json

  - id: coverage_ja
    use:
      pillars: discover_pillars
    invoke:
      mcp: novanet
      tool: novanet_traverse
      params:
        start_key: "ja-JP"
        arc_kinds: ["FOR_LOCALE"]
        direction: "incoming"
        target_kinds: ["PageNative"]
        max_depth: 1
        limit: 100
        include_properties: true
    output:
      format: json

  # ─────────────────────────────────────────────────────────────────
  # PHASE 2: Gap analysis (fan-in)
  # ─────────────────────────────────────────────────────────────────

  - id: gap_analysis
    use:
      pillars: discover_pillars
      fr: coverage_fr
      en: coverage_en
      es: coverage_es
      de: coverage_de
      pt: coverage_pt
      ja: coverage_ja
    infer:
      prompt: |
        Analyze content coverage gaps for QR Code AI.

        PILLAR ENTITIES:
        {{use.pillars}}

        EXISTING PAGES PER LOCALE:
        - fr-FR: {{use.fr}}
        - en-US: {{use.en}}
        - es-ES: {{use.es}}
        - de-DE: {{use.de}}
        - pt-BR: {{use.pt}}
        - ja-JP: {{use.ja}}

        TASK:
        1. Build coverage matrix (entity x locale): EXISTS / MISSING
        2. Top 5 highest-priority gaps
        3. Estimate generation effort
        4. Output prioritized sprint plan

        Format: markdown table + numbered priority list.

  - id: sprint_plan
    use:
      gaps: gap_analysis
    infer:
      prompt: |
        Convert gap analysis into actionable Nika workflow plan.

        GAP ANALYSIS:
        {{use.gaps}}

        For top 5 priority gaps, generate:
        1. Nika YAML snippet (invoke: novanet_generate)
        2. Estimated runtime (30s per block)
        3. Total generation time

        Output ready-to-execute sprint plan with copy-paste YAML.

flows:
  - source: discover_pillars
    target: [coverage_fr, coverage_en, coverage_es, coverage_de, coverage_pt, coverage_ja]
  - source: [discover_pillars, coverage_fr, coverage_en, coverage_es, coverage_de, coverage_pt, coverage_ja]
    target: gap_analysis
  - source: gap_analysis
    target: sprint_plan
